{"version":3,"sources":["updater.js.flow"],"names":["CacheConf","require","moment","readPkg","latestVersion","got","Updater","cache","configName","cwd","process","env","alfred_workflow_cache","version","alfred_workflow_version","interval","bundleId","alfred_workflow_bundleid","console","error","searchParam","encodeURIComponent","pkgUrl","catch","err","then","response","versionMatches","body","match","length","url","checkedOnline","latest","set","maxAge","as","pkg","name","source","get","toLowerCase","checkNpm","checkPackal","module","exports"],"mappings":"ucAEA,GAAMA,CAAAA,SAAS,CAAGC,OAAO,CAAC,YAAD,CAAzB,CACA,GAAMC,CAAAA,MAAM,CAAGD,OAAO,CAAC,QAAD,CAAtB,CACA,GAAME,CAAAA,OAAO,CAAGF,OAAO,CAAC,UAAD,CAAvB,CACA,GAAMG,CAAAA,aAAa,CAAGH,OAAO,CAAC,gBAAD,CAA7B,CACA,GAAMI,CAAAA,GAAG,CAAGJ,OAAO,CAAC,KAAD,CAAnB,C,GAKMK,CAAAA,O,YAYF,kBAAc,4CAEV,KAAKC,KAAL,CAAa,GAAIP,CAAAA,SAAJ,CAAc,CACvBQ,UAAU,CAAE,SADW,CAEvBC,GAAG,CAAEC,OAAO,CAACC,GAAR,CAAYC,qBAFM,CAGvBC,OAAO,CAAEH,OAAO,CAACC,GAAR,CAAYG,uBAHE,CAAd,CAAb,CAKH,C,kKAOiBC,Q,0JAERC,Q,CAAoBN,OAAO,CAACC,GAAR,CAAYM,wB,IAEjCD,Q,yBACDE,OAAO,CAACC,KAAR,CAAc,gDAAd,E,wCAKEC,W,CAAsBC,kBAAkB,CAAC,mBAAqBL,QAAtB,C,CACxCM,M,CAAkB,kEAAiEF,WAAY,O,uBAElFf,CAAAA,GAAG,CAAE,oDAAmDW,QAAS,cAA9D,CAAH,CACdO,KADc,CACR,SAAAC,GAAG,CAAI,CAEVN,OAAO,CAACC,KAAR,CAAcK,GAAd,EACA,MAAO,MAAP,CACH,CALc,EAMdC,IANc,CAMT,SAAAC,QAAQ,CAAI,CAEd,GAAIC,CAAAA,cAAc,CAAGD,QAAQ,CAACE,IAAT,CAAcC,KAAd,CAAoB,0BAApB,CAArB,CAEA,GAAIF,cAAc,EAAIA,cAAc,CAACG,MAAf,CAAwB,CAA9C,CAAiD,CAC7C,MAAO,CACHjB,OAAO,CAAEc,cAAc,CAAC,CAAD,CADpB,CAEHI,GAAG,CAAET,MAFF,CAGHU,aAAa,CAAE,KAHZ,CAAP,CAKH,CAED,MAAO,MAAP,CACH,CAnBc,C,QAAfC,M,eAsBJ,KAAK1B,KAAL,CAAW2B,GAAX,CAAe,uBAAf,CAAwCD,MAAxC,CAAgD,CAC5CE,MAAM,CAAEpB,QAAQ,CAACqB,EAAT,CAAY,cAAZ,CADoC,CAAhD,EAKA,GAAIH,MAAJ,CAAY,CACRA,MAAM,CAACD,aAAP,CAAuB,IAAvB,CACH,C,gCAEMC,M,uRAQIlB,Q,2JAA2BsB,G,kDAAe,I,cAE/CA,G,iEAAalC,CAAAA,OAAO,CAACO,OAAO,CAACD,GAAR,EAAD,C,2CAA1B4B,G,cAGMN,G,CAAe,iCAAgCM,GAAG,CAACC,IAAK,E,yBAG3ClC,CAAAA,aAAa,CAACiC,GAAG,CAACC,IAAL,CAAb,CACdf,KADc,CACR,SAAAC,GAAG,CAAI,CAEVN,OAAO,CAACC,KAAR,CAAcK,GAAd,EACA,MAAO,MAAP,CACH,CALc,EAMdC,IANc,CAMT,SAAAZ,OAAO,QAAK,CACdA,OAAO,CAAEA,OADK,CAEdkB,GAAG,CAAEA,GAFS,CAGdC,aAAa,CAAE,KAHD,CAAL,EANE,C,SAAfC,M,gBAaJ,KAAK1B,KAAL,CAAW2B,GAAX,CAAe,oBAAf,CAAqCD,MAArC,CAA6C,CACzCE,MAAM,CAAEpB,QAAQ,CAACqB,EAAT,CAAY,cAAZ,CADiC,CAA7C,EAKA,GAAIH,MAAJ,CAAY,CACRA,MAAM,CAACD,aAAP,CAAuB,IAAvB,CACH,C,iCAEMC,M,yRASQM,M,CAAgBxB,Q,uJAA2BsB,G,kDAAe,I,CAErEJ,M,CAAS,KAAK1B,KAAL,CAAWiC,GAAX,CAAgB,kBAAiBD,MAAO,EAAxC,C,MAGTN,MAAM,GAAK,K,uEAKVA,M,wCACOM,MAAM,CAACE,WAAP,E,+BACC,K,kBAEA,Q,oDADM,KAAKC,QAAL,CAAc3B,QAAd,CAAwBsB,GAAxB,C,0CAEA,KAAKM,WAAL,CAAiB5B,QAAjB,C,oDAOnBkB,MAAM,CAACD,aAAP,CAAuB,KAAvB,C,iCAEOC,M,4LAIfW,MAAM,CAACC,OAAP,CAAiB,GAAIvC,CAAAA,OAAJ,EAAjB","sourcesContent":["// @flow\n\nconst CacheConf = require('cache-conf');\nconst moment = require('moment');\nconst readPkg = require('read-pkg');\nconst latestVersion = require('latest-version');\nconst got = require('got');\n\n/**\n * Hugo Updater\n */\nclass Updater {\n    /**\n     * Cache store\n     * @see https://www.npmjs.com/package/cache-conf\n     * @type {CacheConf}\n     */\n    cache: CacheConf;\n\n    /**\n     * Hugo updater constructor\n     * @constructor\n     */\n    constructor() {\n        // Configure cache store\n        this.cache = new CacheConf({\n            configName: 'updater',\n            cwd: process.env.alfred_workflow_cache,\n            version: process.env.alfred_workflow_version\n        });\n    }\n\n    /**\n     * Check Packal for updates\n     * @param {moment.Duration} interval Update interval\n     * @async\n     */\n    async checkPackal(interval: moment.Duration): Object {\n        // Bundle ID\n        const bundleId: ?string = process.env.alfred_workflow_bundleid;\n\n        if (!bundleId) {\n            console.error('No bundle ID, not checking Packal for updates.');\n            return;\n        }\n\n        // Packal URL\n        const searchParam: string = encodeURIComponent('site:packal.org ' + bundleId);\n        const pkgUrl: string = `https://encrypted.google.com/search?sourceid=chrome&ie=UTF-8&q=${searchParam}&btnI`;\n\n        let latest = await got(`https://github.com/packal/repository/blob/master/${bundleId}/appcast.xml`)\n            .catch(err => {\n                // Set to false on failure (e.g. not found).\n                console.error(err);\n                return false;\n            })\n            .then(response => {\n                // Get version from XML\n                let versionMatches = response.body.match(/<version>(.+)<\\/version>/);\n\n                if (versionMatches && versionMatches.length > 0) {\n                    return {\n                        version: versionMatches[1],\n                        url: pkgUrl,\n                        checkedOnline: false\n                    };\n                }\n\n                return false;\n            });\n\n        // Cache results\n        this.cache.set('latest_version_packal', latest, {\n            maxAge: interval.as('milliseconds')\n        });\n\n        // Got it from the internet!\n        if (latest) {\n            latest.checkedOnline = true;\n        }\n\n        return latest;\n    }\n\n    /**\n     * Check NPM for updates\n     * @param {moment.Duration} interval Update interval\n     * @async\n     */\n    async checkNpm(interval: moment.Duration, pkg: ?Object = null): Object {\n        // Get details from package.json\n        pkg = pkg || await readPkg(process.cwd());\n\n        // NPM URL\n        const url: string = `https://www.npmjs.com/package/${pkg.name}`;\n\n        // Check for updates\n        let latest = await latestVersion(pkg.name)\n            .catch(err => {\n                // Set to false on failure (e.g. not found).\n                console.error(err);\n                return false;\n            })\n            .then(version => ({\n                version: version,\n                url: url,\n                checkedOnline: false\n            }));\n\n        // Cache results\n        this.cache.set('latest_version_npm', latest, {\n            maxAge: interval.as('milliseconds')\n        });\n\n        // Got it from the internet!\n        if (latest) {\n            latest.checkedOnline = true;\n        }\n\n        return latest;\n    }\n\n    /**\n     * Check for updates\n     * @param {string} source Update source (npm or packal)\n     * @param {moment.Duration} interval Update interval\n     * @async\n     */\n    async checkUpdates(source: string, interval: moment.Duration, pkg: ?Object = null): Object {\n        // Get from cache\n        let latest = this.cache.get(`latest_version_${source}`);\n\n        // Don't do anything if the package wasn't found last time.\n        if (latest === false) {\n            return;\n        }\n\n        // Check for updates online\n        if (!latest) {\n            switch (source.toLowerCase()) {\n                case 'npm':\n                    return this.checkNpm(interval, pkg);\n                case 'packal':\n                    return this.checkPackal(interval);\n                default:\n                    return;\n            }\n        }\n\n        // Got it from cache!\n        latest.checkedOnline = false;\n\n        return latest;\n    }\n}\n\nmodule.exports = new Updater();\n"],"file":"updater.js"}