"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var crypto=require('crypto');var EventEmitter=require('events').EventEmitter;var fs=require('fs-extra');var path=require('path');var FileCacheStore=function(){function FileCacheStore(){(0,_classCallCheck2.default)(this,FileCacheStore);this._contents={};}(0,_createClass2.default)(FileCacheStore,[{key:"store",value:function store(value){this._contents=value;return this;}},{key:"set",value:function set(key,value){this._contents[key]=value;return this;}},{key:"contents",get:function get(){return this._contents;}}]);return FileCacheStore;}();var FileCache=function(_EventEmitter){(0,_inherits2.default)(FileCache,_EventEmitter);function FileCache(filePath,cacheName,cacheDir){var _this;(0,_classCallCheck2.default)(this,FileCache);_this=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(FileCache).call(this));_this.filePath=filePath;_this.cacheName=cacheName;_this.cacheDir=cacheDir;_this.isCleaning=false;return _this;}(0,_createClass2.default)(FileCache,[{key:"_fileExists",value:function _fileExists(path){try{fs.statSync(path);return true;}catch(err){return false;}}},{key:"get",value:function get(){if(this._fileExists(this.filePath)){var eventResult=new FileCacheStore();var file=fs.readFileSync(this.filePath,'utf8');var hash=crypto.createHash('sha1').update(file,'utf8').digest('hex');if(!this.cacheDir){this.emit('change',eventResult,file,hash);return eventResult.contents;}var cachePath=path.join(this.cacheDir,this.cacheName,hash);if(this._fileExists(cachePath)){return fs.readJsonSync(cachePath,{throws:false});}fs.ensureDirSync(path.dirname(cachePath));this.emit('change',eventResult,file,hash);fs.writeJsonSync(cachePath,eventResult.contents);return eventResult.contents;}return null;}},{key:"clearCache",value:function(){var _clearCache=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee(){return _regenerator.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(this.cacheDir){_context.next=2;break;}return _context.abrupt("return");case 2:return _context.abrupt("return",fs.emptyDir(path.join(this.cacheDir,this.cacheName)));case 3:case"end":return _context.stop();}}},_callee,this);}));function clearCache(){return _clearCache.apply(this,arguments);}return clearCache;}()},{key:"clearCacheSync",value:function clearCacheSync(){if(!this.cacheDir){return;}return fs.emptyDirSync(path.join(this.cacheDir,this.cacheName));}}]);return FileCache;}(EventEmitter);module.exports=FileCache;
//# sourceMappingURL=file-cache.js.map
